name: Nightly Full Validation

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  full-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt -r services/frontend/requirements.txt -r services/tasks/requirements.txt -r gateway/requirements.txt
      - run: python -m pytest services/auth/tests -v
      - run: python -m pytest services/frontend/tests -v
      - run: python -m pytest services/tasks/tests -v
      - run: python -m pytest gateway/tests -v
      - run: python -m pytest tests/cross_service -v

  nightly-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/generate-keys
      - run: docker compose -p taskapp-nightly -f docker-compose.test.yml up -d --build
      - name: Wait for health
        run: scripts/wait-for-health.sh http://localhost:5000 45 2 docker compose -p taskapp-nightly -f docker-compose.test.yml logs
      - run: pip install -r requirements-dev.txt
      - run: playwright install chromium --with-deps
      - run: TEST_BASE_URL=http://localhost:5000 python -m pytest tests/smoke -v
      - run: TEST_BASE_URL=http://localhost:5000 python -m pytest tests/e2e -v --browser chromium
      - name: Upload E2E screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-e2e-screenshots
          path: test-results/screenshots/
          retention-days: 7
      - if: always()
        run: docker compose -p taskapp-nightly -f docker-compose.test.yml down -v --remove-orphans

  performance-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/generate-keys

      - name: Build and start stack
        run: docker compose -p taskapp-nightly-perf -f docker-compose.yml up -d --build

      - name: Wait for health checks
        run: scripts/wait-for-health.sh http://localhost:5000 45 2 docker compose -p taskapp-nightly-perf -f docker-compose.yml logs

      - name: Install test dependencies
        run: pip install -r requirements-dev.txt

      - name: Run mixed workload scenario
        run: |
          mkdir -p results
          locust -f tests/performance/locustfile.py \
            --host http://localhost:5000 \
            --headless \
            --only-summary \
            --reset-stats \
            --exit-code-on-error 0 \
            --tags mixed \
            --users 10 \
            --spawn-rate 3 \
            --run-time 60s \
            --csv results/nightly_mixed \
            --html results/nightly_mixed.html

      - name: Check mixed workload thresholds
        run: |
          python tests/performance/check_thresholds.py \
            --stats results/nightly_mixed_stats.csv \
            --thresholds tests/performance/thresholds.yml

      - name: Run auth storm scenario
        run: |
          locust -f tests/performance/locustfile.py \
            --host http://localhost:5000 \
            --headless \
            --only-summary \
            --reset-stats \
            --exit-code-on-error 0 \
            --tags auth \
            --users 10 \
            --spawn-rate 5 \
            --run-time 60s \
            --csv results/nightly_auth \
            --html results/nightly_auth.html

      - name: Check auth storm thresholds
        run: |
          python tests/performance/check_thresholds.py \
            --stats results/nightly_auth_stats.csv \
            --thresholds tests/performance/thresholds.yml

      - name: Run task CRUD scenario
        run: |
          locust -f tests/performance/locustfile.py \
            --host http://localhost:5000 \
            --headless \
            --only-summary \
            --reset-stats \
            --exit-code-on-error 0 \
            --tags crud \
            --users 10 \
            --spawn-rate 3 \
            --run-time 60s \
            --csv results/nightly_crud \
            --html results/nightly_crud.html

      - name: Check task CRUD thresholds
        run: |
          python tests/performance/check_thresholds.py \
            --stats results/nightly_crud_stats.csv \
            --thresholds tests/performance/thresholds.yml

      - name: Upload performance artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-performance-results
          path: |
            results/nightly_mixed*
            results/nightly_auth*
            results/nightly_crud*
          retention-days: 30

      - name: Teardown
        if: always()
        run: docker compose -p taskapp-nightly-perf -f docker-compose.yml down -v --remove-orphans
