name: Nightly Full Validation

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  full-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt -r services/tasks/requirements.txt -r gateway/requirements.txt
      - run: cd services/auth && PYTHONPATH=../.. pytest tests -v
      - run: cd services/tasks && PYTHONPATH=../.. pytest tests -v
      - run: cd gateway && PYTHONPATH=.. pytest tests -v
      - run: PYTHONPATH=. pytest tests/cross_service -v

  nightly-ui:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/generate-keys
      - run: docker compose -p taskapp-nightly -f docker-compose.test.yml up -d --build
      - name: Wait for health
        run: |
          for i in {1..45}; do
            if curl -sf http://localhost:5000/api/health > /dev/null && curl -sf http://localhost:5000/api/auth/health > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          docker compose -p taskapp-nightly -f docker-compose.test.yml logs
          exit 1
      - run: pip install -r requirements-dev.txt
      - run: TEST_BASE_URL=http://localhost:5000 pytest tests/smoke -v
      - if: always()
        run: docker compose -p taskapp-nightly -f docker-compose.test.yml down -v --remove-orphans

