name: PR Checks

on:
  pull_request:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      frontend: ${{ steps.filter.outputs.frontend }}
      tasks: ${{ steps.filter.outputs.tasks }}
      gateway: ${{ steps.filter.outputs.gateway }}
      cross: ${{ steps.filter.outputs.cross }}
      security: ${{ steps.filter.outputs.security }}
      sast: ${{ steps.filter.outputs.sast }}
      smoke: ${{ steps.filter.outputs.smoke }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'services/auth/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pyproject.toml'
            tasks:
              - 'services/tasks/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pyproject.toml'
            frontend:
              - 'services/frontend/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pyproject.toml'
            gateway:
              - 'gateway/**'
              - 'docker-compose*.yml'
              - 'pyproject.toml'
            cross:
              - 'services/**'
              - 'shared/**'
              - 'tests/cross_service/**'
              - 'contracts/**'
              - 'pyproject.toml'
            security:
              - 'services/**'
              - 'gateway/**'
              - 'shared/**'
              - 'tests/security/**'
              - 'pyproject.toml'
            sast:
              - 'services/**'
              - 'gateway/**'
              - 'pyproject.toml'
            smoke:
              - 'services/**'
              - 'gateway/**'
              - 'shared/**'
              - 'keys/**'
              - 'scripts/wait-for-health.sh'
              - 'tests/smoke/**'
              - '.github/actions/**'
              - 'tests/e2e/**'
              - 'docker-compose*.yml'
              - 'pyproject.toml'

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[lint]"
      - run: python -m ruff check .

  auth-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest services/auth/tests -m "not security" --cov=services/auth/auth_app --cov-report=term-missing --cov-report=xml:coverage-auth.xml --cov-report=html:htmlcov/auth --cov-fail-under=0 -v
      - name: Publish auth coverage summary
        if: always()
        run: |
          {
            echo "### Auth Coverage"
            if [ -f .coverage ]; then
              python -m coverage report --format=markdown --fail-under=0
            else
              echo "_No coverage data generated._"
            fi
            echo
            echo "_HTML artifact: coverage-auth_"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-auth
          path: |
            coverage-auth.xml
            htmlcov/auth/
          retention-days: 14
          if-no-files-found: ignore

  task-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.tasks == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest services/tasks/tests -m "not security" --cov=services/tasks/task_app --cov-report=term-missing --cov-report=xml:coverage-tasks.xml --cov-report=html:htmlcov/tasks --cov-fail-under=0 -v
      - name: Publish tasks coverage summary
        if: always()
        run: |
          {
            echo "### Tasks Coverage"
            if [ -f .coverage ]; then
              python -m coverage report --format=markdown --fail-under=0
            else
              echo "_No coverage data generated._"
            fi
            echo
            echo "_HTML artifact: coverage-tasks_"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-tasks
          path: |
            coverage-tasks.xml
            htmlcov/tasks/
          retention-days: 14
          if-no-files-found: ignore

  frontend-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest services/frontend/tests -m "not security" --cov=services/frontend/frontend_app --cov-report=term-missing --cov-report=xml:coverage-frontend.xml --cov-report=html:htmlcov/frontend --cov-fail-under=0 -v
      - name: Publish frontend coverage summary
        if: always()
        run: |
          {
            echo "### Frontend Coverage"
            if [ -f .coverage ]; then
              python -m coverage report --format=markdown --fail-under=0
            else
              echo "_No coverage data generated._"
            fi
            echo
            echo "_HTML artifact: coverage-frontend_"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-frontend
          path: |
            coverage-frontend.xml
            htmlcov/frontend/
          retention-days: 14
          if-no-files-found: ignore

  gateway-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest gateway/tests -m "not security" --cov=gateway/gateway_app --cov-report=term-missing --cov-report=xml:coverage-gateway.xml --cov-report=html:htmlcov/gateway --cov-fail-under=0 -v
      - name: Publish gateway coverage summary
        if: always()
        run: |
          {
            echo "### Gateway Coverage"
            if [ -f .coverage ]; then
              python -m coverage report --format=markdown --fail-under=0
            else
              echo "_No coverage data generated._"
            fi
            echo
            echo "_HTML artifact: coverage-gateway_"
            echo
          } >> "$GITHUB_STEP_SUMMARY"
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-gateway
          path: |
            coverage-gateway.xml
            htmlcov/gateway/
          retention-days: 14
          if-no-files-found: ignore

  cross-service-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.cross == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest tests/cross_service -m "not security" -v

  security-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.security == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: python -m pytest tests/security -v

  sast:
    needs: [changes]
    if: needs.changes.outputs.sast == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[security]"
      - run: python -m bandit -r services gateway -c pyproject.toml

  smoke-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.smoke == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: pyproject.toml
      - uses: ./.github/actions/generate-keys
      - run: docker compose -p taskapp-test -f docker-compose.test.yml up -d --build
      - name: Wait for services
        run: scripts/wait-for-health.sh http://localhost:5000 30 2 docker compose -p taskapp-test -f docker-compose.test.yml logs
      - run: python -m pip install --upgrade pip
      - run: python -m pip install ".[test]"
      - run: TEST_BASE_URL=http://localhost:5000 python -m pytest tests/smoke -v
      - if: always()
        run: docker compose -p taskapp-test -f docker-compose.test.yml down -v --remove-orphans
