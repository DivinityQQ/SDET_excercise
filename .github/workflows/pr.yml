name: PR Checks

on:
  pull_request:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      tasks: ${{ steps.filter.outputs.tasks }}
      gateway: ${{ steps.filter.outputs.gateway }}
      cross: ${{ steps.filter.outputs.cross }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'services/auth/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            tasks:
              - 'services/tasks/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            gateway:
              - 'gateway/**'
              - 'docker-compose*.yml'
              - 'pytest.ini'
            cross:
              - 'services/**'
              - 'shared/**'
              - 'tests/cross_service/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            e2e:
              - 'services/**'
              - 'gateway/**'
              - 'tests/e2e/**'
              - 'docker-compose*.yml'
              - 'pytest.ini'
              - 'requirements-dev.txt'

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install ruff
      - run: ruff check .

  auth-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt
      - run: cd services/auth && PYTHONPATH=../.. pytest tests -v

  task-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.tasks == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/tasks/requirements.txt
      - run: cd services/tasks && PYTHONPATH=../.. pytest tests -v

  gateway-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r gateway/requirements.txt
      - run: cd gateway && PYTHONPATH=.. pytest tests -v

  cross-service-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.cross == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt -r services/tasks/requirements.txt
      - run: PYTHONPATH=. pytest tests/cross_service -v

  ui-smoke:
    needs: [lint, changes]
    if: needs.changes.outputs.e2e == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: docker compose -p taskapp-test -f docker-compose.test.yml up -d --build
      - name: Wait for services
        run: |
          for i in {1..30}; do
            if curl -sf http://localhost:5000/api/health > /dev/null && curl -sf http://localhost:5000/api/auth/health > /dev/null; then
              exit 0
            fi
            sleep 2
          done
          docker compose -p taskapp-test -f docker-compose.test.yml logs
          exit 1
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt
      - run: TEST_BASE_URL=http://localhost:5000 pytest tests/smoke -v
      - if: always()
        run: docker compose -p taskapp-test -f docker-compose.test.yml down -v --remove-orphans

