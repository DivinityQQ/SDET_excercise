name: PR Checks

on:
  pull_request:
    branches: [main]

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      auth: ${{ steps.filter.outputs.auth }}
      frontend: ${{ steps.filter.outputs.frontend }}
      tasks: ${{ steps.filter.outputs.tasks }}
      gateway: ${{ steps.filter.outputs.gateway }}
      cross: ${{ steps.filter.outputs.cross }}
      e2e: ${{ steps.filter.outputs.e2e }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            auth:
              - 'services/auth/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            tasks:
              - 'services/tasks/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            frontend:
              - 'services/frontend/**'
              - 'shared/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            gateway:
              - 'gateway/**'
              - 'docker-compose*.yml'
              - 'pytest.ini'
            cross:
              - 'services/**'
              - 'shared/**'
              - 'tests/cross_service/**'
              - 'contracts/**'
              - 'pytest.ini'
              - 'requirements-dev.txt'
            e2e:
              - 'services/**'
              - 'gateway/**'
              - 'shared/**'
              - 'keys/**'
              - 'scripts/wait-for-health.sh'
              - 'tests/smoke/**'
              - '.github/actions/**'
              - 'tests/e2e/**'
              - 'docker-compose*.yml'
              - 'pytest.ini'
              - 'requirements-dev.txt'

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install ruff
      - run: ruff check .

  auth-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.auth == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt
      - run: python -m pytest services/auth/tests -v

  task-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.tasks == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/tasks/requirements.txt
      - run: python -m pytest services/tasks/tests -v

  frontend-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/frontend/requirements.txt
      - run: python -m pytest services/frontend/tests -v

  gateway-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.gateway == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r gateway/requirements.txt
      - run: python -m pytest gateway/tests -v

  cross-service-tests:
    needs: [lint, changes]
    if: needs.changes.outputs.cross == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.13"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt
            requirements-dev.txt
            services/auth/requirements.txt
            services/tasks/requirements.txt
            services/frontend/requirements.txt
            gateway/requirements.txt
      - run: python -m pip install --upgrade pip
      - run: pip install -r requirements-dev.txt -r services/auth/requirements.txt -r services/tasks/requirements.txt
      - run: python -m pytest tests/cross_service -v

  ui-smoke:
    needs: [lint, changes]
    if: needs.changes.outputs.e2e == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/generate-keys
      - run: docker compose -p taskapp-test -f docker-compose.test.yml up -d --build
      - name: Wait for services
        run: scripts/wait-for-health.sh http://localhost:5000 30 2 docker compose -p taskapp-test -f docker-compose.test.yml logs
      - run: pip install -r requirements-dev.txt
      - run: TEST_BASE_URL=http://localhost:5000 python -m pytest tests/smoke -v
      - if: always()
        run: docker compose -p taskapp-test -f docker-compose.test.yml down -v --remove-orphans
