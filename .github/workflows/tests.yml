# =============================================================================
# CI/CD Pipeline for SDET Learning Platform
# =============================================================================
#
# This GitHub Actions workflow demonstrates CI/CD best practices for testing:
# - Running tests on every push and pull request
# - Single Python version for consistency
# - Separate jobs for API and UI tests
# - Test reporting and artifact uploads
#
# Key SDET Concepts:
# - Continuous Integration/Continuous Deployment
# - Automated test execution
# - Artifact management (reports, screenshots)
#
# Local Testing (not run in CI to save minutes):
#   pytest -m "smoke"                    # Quick smoke tests
#   pytest tests/ --cov=app              # Full suite with coverage
# =============================================================================

name: Test Suite

# Trigger on push to main and all pull requests
# Skip CI for docs-only changes
on:
  push:
    branches: [main, master]
    paths-ignore:
      - "*.md"
      - ".gitignore"
      - "LICENSE"
  pull_request:
    branches: [main, master]
    paths-ignore:
      - "*.md"
      - ".gitignore"
      - "LICENSE"

# Environment variables available to all jobs
env:
  FLASK_ENV: testing
  PYTHONDONTWRITEBYTECODE: 1

jobs:
  # ===========================================================================
  # Linting Job - Quick feedback on code quality
  # ===========================================================================
  lint:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install ruff
        run: pip install ruff

      - name: Run linter
        run: ruff check . --output-format=github

  # ===========================================================================
  # API Tests - Fast, no browser needed
  # ===========================================================================
  api-tests:
    name: API Tests
    runs-on: ubuntu-latest
    needs: lint  # Only run if linting passes

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run API tests
        run: |
          pytest tests/api -v \
            --html=reports/api-test-report.html \
            --self-contained-html \
            -m "api"

      - name: Upload API test report
        uses: actions/upload-artifact@v4
        if: always()  # Upload even if tests fail
        with:
          name: api-test-report
          path: reports/api-test-report.html
          retention-days: 30

  # ===========================================================================
  # UI Tests - Browser-based E2E tests
  # ===========================================================================
  ui-tests:
    name: UI Tests (Playwright)
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: playwright install --with-deps chromium

      - name: Run UI tests
        run: |
          pytest tests/ui -v \
            --html=reports/ui-test-report.html \
            --self-contained-html \
            -m "ui" \
            --browser chromium

      - name: Upload UI test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-report
          path: reports/ui-test-report.html
          retention-days: 30

      - name: Upload screenshots on failure
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: failure-screenshots
          path: test-results/screenshots/
          retention-days: 7

  # ===========================================================================
  # Mock Tests - Unit tests with mocking
  # ===========================================================================
  mock-tests:
    name: Mock/Unit Tests
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run mock tests
        run: |
          pytest tests/mocks -v \
            --html=reports/mock-test-report.html \
            --self-contained-html

      - name: Upload mock test report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mock-test-report
          path: reports/mock-test-report.html
          retention-days: 30
